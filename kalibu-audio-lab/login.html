<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Entrar - Kalibu Áudio Lab</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    .container-form{max-width:520px;margin:2rem auto;padding:1.5rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);background:#fff}
    .grupo{margin-bottom:.9rem}
    .grupo label{display:block;margin-bottom:.3rem;font-weight:600}
    .grupo input{width:100%;padding:.7rem .8rem;border-radius:10px;border:1px solid #ddd;outline:none}
    .acoes{margin-top:1rem;display:flex;gap:.6rem}
    .btn{cursor:pointer;padding:.7rem 1rem;border-radius:10px;border:none}
    .btn-primaria{background:#222;color:#fff}
    .btn-secundaria{background:#f1f1f1}
    .msg{margin-top:1rem;font-weight:600}
    .msg.ok{color:#0a7d2f}.msg.erro{color:#a81010}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <img src="assets/images/Logo principal k.png" alt="Logo Kalibu Áudio Lab" class="logo"/>
      <nav>
        <ul class="menu">
          <li><a href="index.html">Início</a></li>
          <li><a href="sobre.html">Sobre</a></li>
          <li><a href="conteudo.html">Conteúdo</a></li>

          <!-- links de autenticação -->
          <li><a href="cadastro.html" id="link-cadastro">Cadastro</a></li>
          <li><a href="login.html" id="link-entrar" class="active">Entrar</a></li>
          <li>
            <button id="btn-sair" style="display:none;background:none;border:none;color:#fff;cursor:pointer;padding:0;">Sair</button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container-form">
    <h1>Entrar</h1>
    <form id="form-login">
      <div class="grupo">
        <label for="email">E-mail</label>
        <input type="email" id="email" required />
      </div>
      <div class="grupo">
        <label for="senha">Senha</label>
        <input type="password" id="senha" required minlength="6" />
      </div>
      <div class="acoes">
        <button type="submit" class="btn btn-primaria">Entrar</button>
        <a class="btn btn-secundaria" href="cadastro.html">Ir para Cadastro</a>
      </div>
      <div id="mensagem" class="msg" aria-live="polite"></div>
    </form>
  </main>

  <script>
    const API = 'http://localhost:4000';

    // Menu: Entrar/Cadastro/Sair
    function atualizarMenuAuth() {
      const token = localStorage.getItem('kalibu_token');
      const temToken = !!token;
      const btnSair = document.getElementById('btn-sair');
      const linkEntrar = document.getElementById('link-entrar');
      const linkCadastro = document.getElementById('link-cadastro');

      if (temToken) {
        if (btnSair) btnSair.style.display = 'inline-block';
        if (linkEntrar) linkEntrar.style.display = 'none';
        if (linkCadastro) linkCadastro.style.display = 'none';
      } else {
        if (btnSair) btnSair.style.display = 'none';
        if (linkEntrar) linkEntrar.style.display = 'inline-block';
        if (linkCadastro) linkCadastro.style.display = 'inline-block';
      }
    }
    async function sair() {
      try { await fetch(`${API}/auth/sair`, { method: 'POST', credentials: 'include' }); } catch {}
      localStorage.removeItem('kalibu_token');
      location.reload();
    }
    document.getElementById('btn-sair')?.addEventListener('click', sair);
    atualizarMenuAuth();

    // Login
    const form = document.getElementById('form-login');
    const msg = document.getElementById('mensagem');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Entrando...'; msg.className = 'msg';

      const email = document.getElementById('email').value.trim();
      const senha = document.getElementById('senha').value;

      try {
        const resp = await fetch(`${API}/auth/entrar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, senha })
        });
        const data = await resp.json();

        if (resp.ok && data.ok) {
          if (data.token) localStorage.setItem('kalibu_token', data.token);
          msg.textContent = 'Login realizado com sucesso! ✅';
          msg.className = 'msg ok';
          setTimeout(() => window.location.href = 'conteudo.html', 700);
        } else {
          msg.textContent = data.mensagem || 'Erro ao entrar.';
          msg.className = 'msg erro';
        }
      } catch {
        msg.textContent = 'Falha de conexão com o servidor.';
        msg.className = 'msg erro';
      }
    });
  </script>
</body>
</html>
