<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro - Kalibu √Åudio Lab</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    .container-form{max-width:520px;margin:2rem auto;padding:1.5rem;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);background:#fff}
    .grupo{margin-bottom:.9rem}
    .grupo label{display:block;margin-bottom:.3rem;font-weight:600}
    .grupo input{width:100%;padding:.7rem .8rem;border-radius:10px;border:1px solid #ddd;outline:none}
    .grupo input.erro{border-color:#c62828;background:#fff5f5}
    .grupo input.ok{border-color:#1b5e20;background:#f5fff6}
    .hint{font-size:.85rem;margin-top:.3rem}
    .hint.ok{color:#0a7d2f}
    .hint.erro{color:#a81010}

    /* Olhinho dentro do input */
    .input-wrap{position:relative}
    .toggle-olho{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      background:none; border:none; cursor:pointer; font-size:1rem; color:#555; padding:.1rem .25rem;
    }
    .toggle-olho:focus{outline:2px solid #8aa; outline-offset:2px}

    .acoes{margin-top:1rem;display:flex;gap:.6rem}
    .btn{cursor:pointer;padding:.7rem 1rem;border-radius:10px;border:none}
    .btn-primaria{background:#222;color:#fff}
    .btn-secundaria{background:#f1f1f1}

    .msg{margin-top:1rem;font-weight:600}
    .msg.ok{color:#0a7d2f}
    .msg.erro{color:#a81010}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <img src="assets/images/Logo principal k.png" alt="Logo Kalibu √Åudio Lab" class="logo"/>
      <nav>
        <ul class="menu">
          <li><a href="index.html">In√≠cio</a></li>
          <li><a href="sobre.html">Sobre</a></li>
          <li><a href="conteudo.html">Conte√∫do</a></li>

          <!-- links de autentica√ß√£o -->
          <li><a href="cadastro.html" id="link-cadastro" class="active">Cadastro</a></li>
          <li><a href="login.html" id="link-entrar">Entrar</a></li>
          <li>
            <button id="btn-sair" style="display:none;background:none;border:none;color:#fff;cursor:pointer;padding:0;">Sair</button>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container-form">
    <h1>Cadastro de Usu√°rio</h1>
    <form id="form-cadastro" novalidate>
      <div class="grupo">
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" required />
      </div>

      <div class="grupo">
        <label for="email">E-mail</label>
        <input type="email" id="email" required />
      </div>

      <div class="grupo">
        <label for="senha">Senha</label>
        <div class="input-wrap">
          <input type="password" id="senha" required minlength="6" />
          <button type="button" id="olho-senha" class="toggle-olho" title="Mostrar senha" aria-pressed="false">üëÅ</button>
        </div>
        <div class="hint">M√≠nimo de 6 caracteres.</div>
      </div>

      <div class="grupo">
        <label for="confirmar">Confirmar senha</label>
        <div class="input-wrap">
          <input type="password" id="confirmar" required minlength="6" />
          <button type="button" id="olho-conf" class="toggle-olho" title="Mostrar senha" aria-pressed="false">üëÅ</button>
        </div>
        <div id="hintConfirmacao" class="hint"></div>
      </div>

      <div class="acoes">
        <button type="submit" class="btn btn-primaria">Cadastrar</button>
        <button type="reset" class="btn btn-secundaria">Limpar</button>
      </div>

      <div id="mensagem" class="msg" aria-live="polite"></div>
    </form>
  </main>

  <script>
    const API = 'http://localhost:4000';

    // Os Menus: Entrar/Cadastro/Sair 
    function atualizarMenuAuth() {
      const token = localStorage.getItem('kalibu_token');
      const temToken = !!token;
      const btnSair = document.getElementById('btn-sair');
      const linkEntrar = document.getElementById('link-entrar');
      const linkCadastro = document.getElementById('link-cadastro');

      if (temToken) {
        if (btnSair) btnSair.style.display = 'inline-block';
        if (linkEntrar) linkEntrar.style.display = 'none';
        if (linkCadastro) linkCadastro.style.display = 'none';
      } else {
        if (btnSair) btnSair.style.display = 'none';
        if (linkEntrar) linkEntrar.style.display = 'inline-block';
        if (linkCadastro) linkCadastro.style.display = 'inline-block';
      }
    }
    async function sair() {
      try { await fetch(`${API}/auth/sair`, { method: 'POST', credentials: 'include' }); } catch {}
      localStorage.removeItem('kalibu_token');
      location.reload();
    }
    document.getElementById('btn-sair')?.addEventListener('click', sair);
    atualizarMenuAuth();

    // Cadastro com confirma√ß√£o de senha e olhinho
    const form   = document.getElementById('form-cadastro');
    const msg    = document.getElementById('mensagem');
    const senha  = document.getElementById('senha');
    const conf   = document.getElementById('confirmar');
    const hint   = document.getElementById('hintConfirmacao');

    // Olhinho: alterna tipo password/text
    function ligarOlho(btnId, inputEl){
      const btn = document.getElementById(btnId);
      if (!btn) return;
      btn.addEventListener('click', () => {
        const visivel = inputEl.type === 'text';
        inputEl.type = visivel ? 'password' : 'text';
        btn.setAttribute('aria-pressed', String(!visivel));
        btn.title = visivel ? 'Mostrar senha' : 'Ocultar senha';
        btn.textContent = visivel ? 'üëÅ' : 'üôà';
      });
    }
    ligarOlho('olho-senha', senha);
    ligarOlho('olho-conf',  conf);

    function validarSenhas() {
      // limpa estilos 
      if (!senha.value && !conf.value) {
        senha.classList.remove('ok','erro');
        conf.classList.remove('ok','erro');
        hint.textContent = '';
        hint.className = 'hint';
        return true;
      }

      if (senha.value.length < 6) {
        senha.classList.remove('ok'); senha.classList.add('erro');
        conf.classList.remove('ok','erro');
        hint.textContent = 'A senha precisa ter pelo menos 6 caracteres.';
        hint.className = 'hint erro';
        return false;
      }

      if (senha.value !== conf.value) {
        senha.classList.remove('ok'); senha.classList.add('erro');
        conf.classList.remove('ok');  conf.classList.add('erro');
        hint.textContent = 'As senhas n√£o coincidem.';
        hint.className = 'hint erro';
        return false;
      }

      senha.classList.remove('erro'); senha.classList.add('ok');
      conf.classList.remove('erro');  conf.classList.add('ok');
      hint.textContent = 'Senhas conferem.';
      hint.className = 'hint ok';
      return true;
    }

    senha.addEventListener('input', validarSenhas);
    conf .addEventListener('input', validarSenhas);

    form.addEventListener('reset', () => {
      // volta inputs para "password" e √≠cones para estado inicial
      senha.type = 'password'; conf.type = 'password';
      document.getElementById('olho-senha').textContent = 'üëÅ';
      document.getElementById('olho-senha').setAttribute('aria-pressed','false');
      document.getElementById('olho-senha').title = 'Mostrar senha';
      document.getElementById('olho-conf').textContent  = 'üëÅ';
      document.getElementById('olho-conf').setAttribute('aria-pressed','false');
      document.getElementById('olho-conf').title  = 'Mostrar senha';

      senha.classList.remove('ok','erro');
      conf.classList.remove('ok','erro');
      hint.textContent = '';
      hint.className = 'hint';
      msg.textContent = '';
      msg.className = 'msg';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'msg';

      if (!validarSenhas()) {
        msg.textContent = 'Corrija os erros acima antes de cadastrar.';
        msg.className = 'msg erro';
        return;
      }

      const nome  = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();

      if (!nome || !email) {
        msg.textContent = 'Preencha nome e e-mail.';
        msg.className = 'msg erro';
        return;
      }

      msg.textContent = 'Enviando...';

      try {
        const resp = await fetch(`${API}/auth/registrar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ nome_completo: nome, email, senha: senha.value })
        });
        const data = await resp.json();

        if (resp.ok && data.ok) {
          if (data.token) localStorage.setItem('kalibu_token', data.token);
          msg.textContent = 'Cadastro realizado com sucesso! ‚úÖ';
          msg.className = 'msg ok';
          setTimeout(() => window.location.href = 'conteudo.html', 700);
        } else {
          msg.textContent = data.mensagem || 'Erro ao cadastrar.';
          msg.className = 'msg erro';
        }
      } catch {
        msg.textContent = 'Falha de conex√£o com o servidor.';
        msg.className = 'msg erro';
      }
    });
  </script>
</body>
</html>
